<!DOCTYPE html>

<html lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>GenomePaint ASE track</title>
	<script src='https://platform.dnanexus.com/javascript/file-viewer-1.1.min.js'></script>
	<script src='https://proteinpaint.stjude.org/bin/proteinpaint.js'></script>
	<!--
	<script src='http://localhost:3001/bin/proteinpaint.js'></script>
	-->
    <style type="text/css">
  
	body {
		margin: 0;
		padding: 0;
	}
	
	.omnibar {
		  width: 100%;
		  background: #1381B3;
		  min-height: 64px;
		  font-family: 'Open Sans', "Helvetica Neue", Helvetica, Arial, sans-serif
	}
  

	.logo {
		display: block;
		float: left;
		margin: 0 auto;
		width: 50px;
		height: 50px;
		color: #fff;
		text-decoration: none;
		padding: 8px 10px;
	}
	
	.logo img {
		border: none;
		margin: 0;
		padding: 0;
		width: 100%;
	}
	
	.site-title {
		font-weight: 300;
		font-size: 22px;
		padding: 0;
		margin: 0;
		color: #A1CDE1;
		padding: 14px;
	}
	
	.site-title a {
		color: #fff;
		text-decoration: none;
		font-weight: 600;
	}
	
	
	.nav {
		float: right;
		margin: 0;
		padding: 20px 30px 20px 0;
	}
	
	.nav li {
		display: inline;
		margin: 0;
		padding: 0;
		margin-left: 40px;
		font-weight: 600;
		font-size: 14px;
	}
	
	.nav li a {
		text-decoration: none;
		color: #fff;
		text-transform: uppercase;
	}
	
  
  </style>


  </head>





  <body>


    <div class="omnibar">
        <ul class="nav">
			<li><a href="https://platform.stjude.cloud/requests/data_by_disease">Data</a></li>
			<li><a href="https://platform.stjude.cloud/tools">Tools</a></li>
			<li><a href="https://platform.stjude.cloud/visualizations/cohort">Visualizations</a></li>
        </ul>
        <a href="index.html" class="logo"><img src="https://pecan.stjude.org/static/stjude-logo-child.png" alt="St. Jude Cloud" title="St. Jude Cloud" /></a>
        <h1 class="site-title"><a href="index.html">St. Jude Cloud</a> GenomePaint ASE track</h1>   
    </div>



    <div class="container-fluid" id="proteinpaintdiv"></div>
    <div class="container-fluid" id="refselect" style="margin:30px;padding:20px;border:solid 1px #bbb;display:inline-block"></div>
    <div class="container-fluid" id="errdiv" style="margin-top:20px"></div>

    <script type="text/javascript">
      getOptions(function(options) {

	    function sayerror(m) {
			const b = document.createElement('div')
			b.style.background='#F7D0D4'
			b.style.margin='5px 30px'
			b.style.padding='4px 10px'
			b.innerHTML = m
			document.getElementById('errdiv').appendChild(b)
		}

        function getPath(file) {
          return file.folder + "/" + file.name;
        }

        var pathToURL = {};
        for (var i = 0; i < options.files.length; ++i) {
          pathToURL[getPath(options.files[i])] = options.files[i].url;
        }

		let vcf
		const sample2bam = new Map()

		for(var path in pathToURL) {
			var filename = path.split('/').pop()
			if(path.endsWith('.vcf.gz')) {
				var indexfile = pathToURL[path+'.csi'] || pathToURL[path+'.tbi']
				if(indexfile) {
					vcf = {
						name: filename.replace(/\.vcf\.gz$/,''),
						url: pathToURL[path],
						indexURL: indexfile,
					}
				} else {
					sayerror('Missing index file (.tbi or .csi) for VCF file ' + filename)
				}
			} else if(path.endsWith('.bam')) {
				var indexfile = pathToURL[path+'.bai']
				if(indexfile) {
					const lst = filename.split('.')
					let totalreads = Number.parseInt(lst[0])
					let samplename
					if(Number.isNaN(totalreads)) {
						sayerror('Cannot get total number of mapped reads from BAM file "'+filename+'". Using placeholder value 1000000 instead. For proper result, add this number to your file name in the format of [number].[sampleName].bam; number and sampleName should not contain dot')
						totalreads = 1000000
						samplename = lst[0]
					} else {
						samplename = lst[1]
					}
					if(!samplename) {
						sayerror('Missing sample name from a BAM file name')
						continue
					}
					sample2bam.set(samplename, {
						totalreads: totalreads,
						pairedend: true,
						url:pathToURL[path],
						indexURL: indexfile,
					})
				}
			}
		}

		let tk

		if(!vcf) {
			sayerror('No VCF file')
			return
		}
		if(sample2bam.size==0) {
			sayerror('No BAM file')
			return
		}
		if(sample2bam.size==1) {
			const [[sample,bam]] = [...sample2bam]
			tk = {
				type:'ase',
				name: sample+' ASE',
				samplename: sample,
				vcfurl: vcf.url,
				vcfindexURL: vcf.indexURL,
				rnabamurl: bam.url,
				rnabamindexURL: bam.indexURL,
				rnabamtotalreads: bam.totalreads,
				rnabamispairedend: true,
			}

		} else {

			if(sample2bam.size>4) {
				sayerror('You submitted '+sample2bam.size+' BAM files. To avoid network timeout, only the first 4 BAM files will be used. We apologize for this inconvenience.')
			}

			tk = {
				type: 'mdssvcnv',
				name: vcf.name+' ASE',
				checkvcf: vcf,
				checkrnabam:{
					samples: {}
				}
			}
			let count=0
			for(const [n,b] of sample2bam) {
				tk.checkrnabam.samples[n] = b
				if(++count > 3) {
					break
				}
			}
		}


		const div = document.getElementById('refselect')

		const runpp = (tk, refgenome)=>{

			div.parentNode.removeChild(div)

			runproteinpaint({
				host:'https://proteinpaint.stjude.org',
				//host:'http://localhost:3001',
				holder:document.getElementById('proteinpaintdiv'),
				block:true,
				genome: refgenome,
				nobox:true,
				noheader:true,
				nativetracks:'refgene',
				tracks:[ tk ]
			})
		}

		const lst = [
			{name:'human hg19', key:'hg19'},
			{name:'human hg38', key:'hg38'},
			{name:'mouse mm9', key:'mm9'},
			{name:'mouse mm10', key:'mm10'}
		]

		const h = document.createElement('h2')
		h.innerHTML = 'Select a reference genome'
		div.appendChild(h)

		for(const g of lst) {
			const b = document.createElement('button')
			b.innerHTML = g.name
			b.style.margin = '10px'
			b.onclick = ()=> runpp( tk, g.key )
			div.appendChild(b)
		}
	})
    </script>
  </body>
</html>
