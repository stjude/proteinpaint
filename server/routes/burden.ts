import { BurdenRequest, BurdenResponse } from '#shared/types/routes/burden.ts'
import lines2R from '#src/lines2R.js'
import path from 'path'
import serverconfig from '#src/serverconfig.js'
import { write_file } from '#src/utils.js'

export const api = {
	endpoint: 'burden',
	methods: {
		get: {
			init() {
				return async (req: undefined, res: any): Promise<void> => {
					try {
						const estimates = await getBurdenEstimates(req)
						const { keys, rows } = formatPayload(estimates)
						res.send({ status: 'ok', keys, rows })
						// res.send(testData)
					} catch (e: any) {
						res.send({ status: 'error', error: e.message || e })
					}
				}
			},
			request: {
				typeId: 'BurdenRequest'
			},
			response: {
				typeId: 'BurdenResponse'
			},
			examples: [
				{
					request: {
						body: {}
					}
				}
			]
		}
	}
}

async function getBurdenEstimates(q) {
	const infile = path.join(serverconfig.cachedir, Math.random().toString() + '.json')
	for (const k in q.query) {
		q.query[k] = Number(q.query[k])
	}
	const data = Object.assign({}, defaults, q.query)
	console.log(40, data, JSON.stringify(data))
	await write_file(infile, JSON.stringify(data))
	// TODO: use the dataset location
	const dsDataDir = `${serverconfig.tpmasterdir}/files/hg38/sjlife/burden`
	const args = [
		infile,
		`${dsDataDir}/cphfits2.RData`,
		`${dsDataDir}/surv.RData`,
		`${dsDataDir}/nchcsampledsex0age0steroid0bleo0vcr0etop0itmt0.RData`
	]
	const Routput = await lines2R(path.join(serverconfig.binpath, 'utils/burden.R'), [], args)
	const estimates = JSON.parse(Routput[0])
	return estimates
}

function formatPayload(estimates) {
	const rawKeys = Object.keys(estimates[0])
	const outKeys = []
	const keys = []
	for (const k of rawKeys) {
		if (k == 'chc') {
			keys.push(k)
			outKeys.push(k)
		} else {
			const age = Number(k.slice(1).split(',')[0])
			if (age <= 60 && age % 2 == 0) {
				keys.push(k)
				outKeys.push(`burden${age}`)
			}
		}
	}
	const rows = []
	// v = an array of objects with age as keys as cumulative burden as value for a given CHC
	for (const v of estimates) {
		rows.push(keys.map(k => v[k]))
	}
	return { keys: outKeys, rows }
}

const defaults = Object.freeze({
	diaggrp: 5,
	sex: 0,
	white: 1,
	agedx: 1,
	// chemotherapy
	steriod: 0,
	bleo: 0,
	vcr: 0, //12, // Vincristine
	etop: 0, //2500, // Etoposide
	itmt: 0, // Intrathecal methothrexate_grp: 0,
	ced: 0, //1.6, // Cyclophosphamide, 0.7692 mean 7692.
	cisp: 0, //300, // Cisplatin
	dox: 0, // Anthracycline, 3 mean 300 ml/m2
	carbo: 0, //  Carboplatin
	hdmtx: 0, // High-Dose Methotrexate
	// radiation
	brain: 0, //5.4,
	chest: 0, //2.4,
	heart: 0,
	pelvis: 0,
	abd: 0 //2.4
})

// # # Input person's values, 18 input X's , plus the input primary DX
// # 	sexval=1  #sex, take value 1 for male and 0 for female
// # 	whiteval=1	# Race white or not, 1 for white, 0 for non-white
// # 	agedxval=6  # age at primary cancer DX

// # #### Chemotherapy
// # 	steroidval=0  #Steroids 1 for yes 0 for no
// # 	bleoval=0; ##Bleomycin
// # 	vcrval=12; 	#Vincristine
// # 	etopval=2500; #Etoposide
// # 	itmtval=0; 		#Intrathecal Methotrexate
// # 	cedval=1.6		# Cyclophosphamide, 0.7692 mean 7692.
// # 	cispval=300		#Cisplatin
// # 	doxval=0		#Anthracycline, 3 mean 300 ml/m2
// # 	carboval=0  ## Carboplatin
// # 	hdmtxval=0	## High-Dose Methotrexate

// # # Radiation
// # 	brainval=5.4 #Brain, 5.4 means 54Gy, 5400 cGy. #####Same for all RT doses.#####
// # 	chestval=2.4 # chest/neck RT, 2.4 for 24 Gy
// # 	heartval=0	# Heart RT
// # 	pelvisval=0	#pelvis RT
// # 	abdval=2.4  # Abdominal RT

const testData = {
	status: 'ok',
	keys: [
		'burden20',
		'burden22',
		'burden24',
		'burden26',
		'burden28',
		'burden30',
		'burden32',
		'burden34',
		'burden36',
		'burden38',
		'burden40',
		'burden42',
		'burden44',
		'burden46',
		'burden48',
		'burden50',
		'burden52',
		'burden54',
		'burden56',
		'burden58',
		'burden60',
		'chc'
	],
	rows: [
		[
			0.0171617733348465, 0.0236537103093256, 0.0347427858219196, 0.049079472842871, 0.0639226669943855,
			0.077806257610083, 0.0904610196419378, 0.105603742163226, 0.125979464520511, 0.149054940859264, 0.171454624705908,
			0.192449202606329, 0.212074579154375, 0.230330754350047, 0.247217728193344, 0.262735500684267, 0.276884071822815,
			0.289663441608988, 0.301073610042786, 0.31111457712421, 0.319786342853259, 1
		],
		[
			0.0190306542237457, 0.0247396962105082, 0.0301291066147201, 0.0361407845953724, 0.0425920406796961,
			0.0494156683461038, 0.0570570343494106, 0.0657559784510768, 0.075744695990676, 0.0864489172580684,
			0.0965334996370524, 0.105964720542634, 0.114780866428383, 0.1229819372943, 0.130567933140385, 0.137538853966639,
			0.14389469977306, 0.149635470559649, 0.154761166326406, 0.159271787073331, 0.163167332800424, 3
		],
		[
			0.0341124999485183, 0.046782895802351, 0.0611438639618031, 0.0755946540819701, 0.0880966361057836,
			0.0989132762430331, 0.109811708390616, 0.12106984186047, 0.131902888465882, 0.141636642025142, 0.150705470881705,
			0.159213543595213, 0.167166746155071, 0.174565078561278, 0.181408540813834, 0.18769713291274, 0.193430854857995,
			0.198609706649599, 0.203233688287553, 0.207302799771856, 0.210817041102508, 4
		],
		[
			0.00689139311252743, 0.0107992253779558, 0.0164521916211719, 0.0242614271616965, 0.0337228531433093,
			0.0434856912090368, 0.0519350797673725, 0.0582500060052141, 0.0626411190587646, 0.0652817736362136,
			0.0671626806757766, 0.0688765751938439, 0.0704786948192176, 0.0719690395518979, 0.0733476093918846,
			0.0746144043391778, 0.0757694243937775, 0.0768126695556837, 0.0777441398248964, 0.0785638352014155,
			0.0792717556852411, 6
		],
		[0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 7],
		[
			0.0135993360103768, 0.0188222984361075, 0.0246977326206008, 0.0319369387901444, 0.0402554475656172,
			0.048235701505429, 0.0548456950772407, 0.0588674983958685, 0.0604730575779407, 0.0608976680689999,
			0.060997410123909, 0.0610709803902075, 0.0611397526315785, 0.0612037268480218, 0.0612629030395376,
			0.0613172812061257, 0.0613668613477863, 0.0614116434645193, 0.0614516275563247, 0.0614868136232024,
			0.0615172016651526, 8
		],
		[
			0.0343556891310918, 0.0477113401744454, 0.0645903659870584, 0.0782074697692962, 0.0881255039626048,
			0.098817858056895, 0.113401720407797, 0.131396479877768, 0.150488174186857, 0.170613532608222, 0.190526354925925,
			0.209266734051337, 0.226784923687432, 0.243080923834211, 0.258154734491673, 0.27200635565982, 0.28463578733865,
			0.296043029528163, 0.30622808222836, 0.315190945439241, 0.322931619160806, 9
		],
		[
			0.609222029701825, 0.800617605542142, 1.04747444550564, 1.33402385526081, 1.62188948474785, 1.90310696855933,
			2.18538323604338, 2.49381201970274, 2.82895261592995, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 10
		],
		[
			0.309663291227289, 0.352231993168202, 0.391799005351932, 0.426275699307447, 0.456225845478614, 0.484986036985677,
			0.513666385825928, 0.540529737640317, 0.562414986640467, 0.580208646554206, 0.596321080994563, 0.611426995899982,
			0.625547749816909, 0.638683342745344, 0.650833774685286, 0.661999045636736, 0.672179155599694, 0.681374104574159,
			0.689583892560132, 0.696808519557613, 0.703047985566602, 11
		],
		[
			0.00400571540056142, 0.00483866348054416, 0.00605124449462973, 0.0076934471609334, 0.00971800198964591,
			0.0119901393686701, 0.0143187419146216, 0.0159099628198535, 0.0166117364755541, 0.0168420695280223,
			0.0169384404283096, 0.0170212084246976, 0.017098578548686, 0.0171705508002749, 0.0172371251794644,
			0.0172983016862544, 0.0173540803206448, 0.0174044610826358, 0.0174494439722273, 0.0174890289894193,
			0.0175232161342118, 12
		],
		[
			0.0204841875156598, 0.0253501069613985, 0.0318110004612252, 0.0431851187359877, 0.0598278661506765,
			0.078859983288503, 0.0986498871156661, 0.117709060001342, 0.131686330150727, 0.140029160105642, 0.146035271107294,
			0.151520879378657, 0.15664873326699, 0.161418832772293, 0.165831177894565, 0.169885768633807, 0.173582604990018,
			0.176921686963199, 0.17990301455335, 0.18252658776047, 0.18479240658456, 13
		],
		[
			0.00652679709885086, 0.0106033066416826, 0.0144941137968833, 0.0183978329682832, 0.0222530706675378,
			0.026181055959216, 0.0294206988804396, 0.0321802826776514, 0.0351995300936958, 0.0382229490247166,
			0.0409488826981037, 0.0434879633504621, 0.0458614530259747, 0.0480693517246413, 0.0501116594464621,
			0.051988376191437, 0.0536995019595661, 0.0552450367508493, 0.0566249805652866, 0.057839333402878,
			0.0588880952636235, 15
		],
		[
			0.079375918475633, 0.0961690779764674, 0.114580105371383, 0.134875408186521, 0.156485139312525, 0.179224667760747,
			0.20503413510816, 0.237062071890951, 0.275757459494483, 0.316856489148277, 0.355925753092799, 0.392510372430877,
			0.426709056194952, 0.458521804385023, 0.48794861700109, 0.514989494043154, 0.539644435511213, 0.561913441405268,
			0.58179651172532, 0.599293646471368, 0.614404845643412, 16
		],
		[
			0.262564561806285, 0.359213294048908, 0.47342939145775, 0.601440684009941, 0.747297252281074, 0.912629957294778,
			1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 17
		],
		[
			0.0411796902968747, 0.0462563431620567, 0.0526314096154558, 0.0581491868400804, 0.0617521227372467,
			0.0641772187788314, 0.0681004680669704, 0.075389150552037, 0.0840231473540537, 0.0910417088721732,
			0.0969038580312909, 0.102339020854563, 0.107419719190704, 0.112145953039715, 0.116517722401595, 0.120535027276344,
			0.124197867663962, 0.127506243564449, 0.130460154977805, 0.133059601904031, 0.135304584343126, 18
		],
		[
			0.00258586096062457, 0.00386226318109397, 0.00550273204809071, 0.00776596847847598, 0.0111301473225415,
			0.0157355476514485, 0.0222587963912506, 0.0306090205903853, 0.038243376662025, 0.0438235079616715,
			0.048349317015083, 0.0525395471686834, 0.0564565034884262, 0.0601001859743113, 0.0634705946263388,
			0.0665677294445087, 0.0693915904288209, 0.0719421775792755, 0.0742194908958725, 0.0762235303786118,
			0.0779542960274935, 19
		],
		[
			0.00604712504321598, 0.00691037632341457, 0.00732173775234041, 0.00813386564452392, 0.0101180857740765,
			0.0132262157498892, 0.0165937753800725, 0.0187959667254995, 0.0197349723228339, 0.0200348003946296,
			0.0201563444807555, 0.0202598149126665, 0.0203565373234467, 0.0204465117130962, 0.020529738081615,
			0.020606216429003, 0.0206759467552602, 0.0207389290603867, 0.0207951633443824, 0.0208446496072474,
			0.0208873878489816, 21
		],
		[
			0.00121011527284054, 0.00136909587212661, 0.00152099455162942, 0.00166430768202687, 0.00177998583888572,
			0.00187724068688241, 0.0019704801656756, 0.00203592739314076, 0.00206661815353739, 0.0020779405965176,
			0.00208345915471355, 0.00208827304758033, 0.00209277299326252, 0.00209695899176013, 0.00210083104307315,
			0.00210438914720159, 0.00210763330414545, 0.00211056351390472, 0.0021131797764794, 0.0021154820918695,
			0.00211747046007502, 22
		],
		[
			0.000354921256358739, 0.00100627929669535, 0.00216690375447667, 0.00375539962878793, 0.0054548223583682,
			0.00705807638785145, 0.00866465392148348, 0.0106254583814319, 0.0125323074827255, 0.0139949112965681,
			0.0152052453077184, 0.0163280712741834, 0.017377670008405, 0.0183540415103833, 0.0192571857801182,
			0.0200871028176098, 0.020843792622858, 0.0215272551958629, 0.0221374905366244, 0.0226744986451426,
			0.0231382795214174, 24
		],
		[
			0.108863546357513, 0.16051598429822, 0.22047111922869, 0.286382176051266, 0.358735544257491, 0.434544269081984,
			0.513040777351258, 0.589125754319644, 0.654662171491125, 0.708375864833934, 0.755466917477837, 0.799313477910916,
			0.840300501461344, 0.87842798812912, 0.913695937914245, 0.946104350816719, 0.975653226836542, 1, 1, 1, 1, 25
		],
		[
			0.0888099589483434, 0.102089804596933, 0.118609904648236, 0.139548379840962, 0.163603117268505, 0.186559120658786,
			0.206244920321228, 0.224472930249232, 0.24333691649432, 0.262079182059808, 0.279386221520627, 0.295544040338398,
			0.310648096252163, 0.324698389261923, 0.337694919367678, 0.349637686569427, 0.36052669086717, 0.370361932260908,
			0.37914341075064, 0.386871126336367, 0.393545079018089, 27
		],
		[
			0.124189748288917, 0.138156663513789, 0.148822330540564, 0.15585130979751, 0.161213179797956, 0.167010284224451,
			0.174153803454096, 0.181953489453157, 0.189136359679158, 0.195572043144304, 0.201599063238587, 0.207243984116537,
			0.212520760736632, 0.217429393098871, 0.221969881203255, 0.226142225049784, 0.229946424638457, 0.233382479969275,
			0.236450391042237, 0.239150157857345, 0.241481780414596, 28
		],
		[
			0.166299800461395, 0.179602878101083, 0.189425863739636, 0.197862979075976, 0.205571593981687, 0.211931840082023,
			0.216482049551543, 0.219667746374363, 0.222353048017248, 0.225120995595437, 0.227909753146377, 0.230535737593946,
			0.232990463468278, 0.235273930769374, 0.237386139497233, 0.239327089651856, 0.241096781233243, 0.242695214241393,
			0.244122388676307, 0.245378304537985, 0.246462961826426, 29
		],
		[
			0.197217734604727, 0.217987866992909, 0.234058650956036, 0.246957757024947, 0.257160502362087, 0.268471317257074,
			0.284843952470349, 0.305632751118574, 0.327182037474935, 0.347995542291384, 0.367657016512585, 0.386139656109347,
			0.403416915190656, 0.41948879375651, 0.434355291806911, 0.448016409341859, 0.460472146361353, 0.471722502865393,
			0.48176747885398, 0.490607074327113, 0.498241289284792, 30
		],
		[
			0.0702256381944407, 0.0977182341720268, 0.129513523216136, 0.166566967941468, 0.205045421890173,
			0.237559897743856, 0.262352366349329, 0.2871973098176, 0.322420707065693, 0.365734068652671, 0.408719253577298,
			0.449095671419288, 0.486838864331703, 0.521948832314543, 0.554425575367807, 0.584269093491496, 0.61147938668561,
			0.636056454950149, 0.658000298285112, 0.6773109166905, 0.693988310166313, 31
		],
		[
			0.00541908324841255, 0.00583346059401826, 0.00690111569198417, 0.00962483103890327, 0.0143769795550977,
			0.0203557432887656, 0.0270824580672118, 0.0364880399710237, 0.0491937802433676, 0.0631265753340124,
			0.076394671764976, 0.088812692148281, 0.100420847699662, 0.111219138419119, 0.121207564306652, 0.130386125362262,
			0.138754821585947, 0.146313652977709, 0.153062619537547, 0.15900172126546, 0.16413095816145, 32
		]
	]
}
