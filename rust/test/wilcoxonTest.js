/********************************************
Test script for 'rust/src/wilcoxon.rs'

benchmarked against R wilcox.test()

to produce random vectors and R pvalue, run "% Rscript wilcoxontest.R" by modifying the code for varying vector length


inside this folder, run test as "% node wilcoxonTest.js"

*********************************************/

// Import necessary modules
import tape from 'tape'
import run_rust from '@sjcrh/proteinpaint-rust'

const testData = [
	// len=10
	{
		group1_id: 'group1_id_iter1',
		group1_values: [-1.1621, 0.2767, -1.5272, -0.4731, -0.5174, 2.0375, -0.1718, 1.4165, 0.7075, 0.7725],
		group2_id: 'group2_id_iter1',
		group2_values: [0.3328, 0.1301, 0.4578, 0.3028, 0.7232, 0.7841, 0.6581, 0.0636, 0.0791, 0.8617],
		R_pvalue: 0.393
	},
	// len=20
	{
		group1_id: 'group1_id_iter1',
		group1_values: [
			1.956, 0.2093, -1.742, -1.0666, -1.8392, 0.9948, -0.1854, 0.8992, 0.5964, 0.7469, -0.3771, 0.5822, 0.7967, 0.3394,
			2.0034, -0.9664, 1.5256, -3.165, -0.732, -0.7337
		],
		group2_id: 'group2_id_iter1',
		group2_values: [
			0.9282, 0.4173, 0.2939, 0.3618, 0.5432, 0.4986, 0.6044, 0.4956, 0.0924, 0.0865, 0.4738, 0.6933, 0.2108, 0.2975,
			0.7153, 0.933, 0.4613, 0.5133, 0.2705, 0.7889
		],
		R_pvalue: 0.4135
	},
	// len=100
	{
		group1_id: 'group1_id_iter1',
		group1_values: [
			-1.549, 1.1307, -0.0567, 1.0738, 0.0163, -0.7173, -0.4022, 0.8672, -0.5388, 0.6918, 1.5268, 2.1887, -1.1407,
			1.7936, 0.0935, 0.0241, -0.3915, 0.3258, 2.3951, -2.0874, -0.4212, 0.1074, -1.2583, 1.1611, -0.9766, -2.1055,
			-1.608, -0.5936, -0.5677, 1.9039, 1.0712, 0.6205, 2.0917, -0.0146, -0.184, -0.2676, -0.0129, -0.646, 0.3842,
			0.623, 1.484, -0.6241, 1.6049, 0.1707, 0.5311, 2.0411, -0.0175, -0.6948, -0.4317, -0.8593, -0.0874, -0.0228,
			0.6568, 0.0412, 1.7324, -0.6144, 2.489, -0.9071, 0.4121, -1.5195, -0.2441, 1.8641, -2.2447, 0.3452, -1.3879,
			0.1381, -1.1787, -1.4349, -0.9127, 0.555, -0.7882, 0.15, 0.1282, -1.0393, 0.7051, -0.6449, 1.5856, -2.1371,
			-0.632, -0.2527, 0.2929, 1.008, -0.3823, -1.3906, -0.5789, 1.6797, -0.8391, 0.02, 1.375, -0.6732, 0.502, 0.5575,
			-1.0965, -0.1602, -0.6618, 0.0148, 1.2971, -0.4454, -0.1838, -2.2963
		],
		group2_id: 'group2_id_iter1',
		group2_values: [
			0.5524, 0.3253, 0.5604, 0.9758, 0.1383, 0.3598, 0.6832, 0.1969, 0.2919, 0.3779, 0.3736, 0.4681, 0.3622, 0.4452,
			0.7613, 0.4984, 0.9732, 0.3853, 0.9603, 0.3849, 0.2275, 0.98, 0.7204, 0.564, 0.3651, 0.0599, 0.257, 0.4332,
			0.4134, 0.0785, 0.736, 0.7163, 0.0346, 0.1292, 0.9325, 0.8159, 0.6315, 0.0072, 0.896, 0.7231, 0.37, 0.1172,
			0.7335, 0.3768, 0.8958, 0.8304, 0.9138, 0.1976, 0.5434, 0.6281, 0.5561, 0.3181, 0.2485, 0.4234, 0.8499, 0.0767,
			0.2647, 0.7724, 0.1922, 0.6497, 0.4998, 0.1096, 0.0024, 0.6758, 0.1441, 0.2417, 0.1545, 0.038, 0.7731, 0.9233,
			0.4717, 0.1389, 0.6272, 0.9227, 0.9288, 0.6496, 0.4636, 0.8958, 0.0433, 0.8639, 0.3706, 0.869, 0.9784, 0.4613,
			0.828, 0.9177, 0.232, 0.3739, 0.8423, 0.4738, 0.6722, 0.4899, 0.2663, 0.4363, 0.386, 0.6252, 0.1364, 0.54, 0.8721,
			0.9935
		],
		R_pvalue: 7.5505e-7
	},
	// len=500
	{
		group1_id: 'group1_id_iter1',
		group1_values: [
			0.3518, 0.3411, -0.0472, -0.2513, 0.1952, -0.9176, 0.1068, 1.4165, 0.634, 0.3596, 0.8184, -1.4354, 0.9295, 0.0024,
			-0.129, 0.7573, 0.2331, 0.3378, 0.8402, 0.2134, 1.6129, 0.2035, 0.0261, 1.3966, 1.3539, -0.4399, 0.8409, 0.6484,
			0.6386, 0.5284, -0.4201, 0.6814, -0.5501, 0.0953, -1.4337, -0.18, 2.7536, -0.707, -0.3225, -1.8634, -0.1381,
			-1.6292, -1.9714, -0.3756, -0.1075, 0.3383, 1.0888, 1.982, 0.074, 0.5932, -0.444, -0.6786, -0.3063, -0.0927,
			-0.9392, 0.5105, 0.8591, 0.6332, -0.0414, 0.05, -0.7123, -1.1006, 0.4116, -0.128, -0.8702, -0.2667, -1.0758,
			0.8483, 0.4662, -0.5116, -0.1104, 0.2945, 0.0013, -0.095, 1.0236, 0.2484, 0.318, -1.012, -0.5328, -0.262, -0.4968,
			-0.8003, -2.2184, 0.2615, -1.4311, -1.4373, -0.4705, 0.9914, 1.0226, 0.6342, -2.6864, 0.0983, -1.1729, -0.4254,
			3.0692, 1.7119, -2.3354, 1.5409, -2.0997, 0.3054, -1.011, 0.1914, 0.9918, -1.1836, -0.9669, 1.1301, -0.7174,
			0.7967, -0.4889, 0.2693, -0.5415, 0.7773, -0.2536, -0.2201, 0.3655, 1.0179, -1.6117, 2.0918, -1.3261, 0.0552,
			-0.3153, 0.7543, 0.4341, -1.8207, 0.5669, -1.0986, 0.3103, -1.3716, 2.9719, -0.0486, -0.6809, 0.9882, 0.6967,
			-0.5277, -0.2258, 0.2343, 0.3568, -0.249, 0.0753, 0.2627, 0.1566, -0.1597, 0.4719, -1.0323, 1.5108, 0.3215,
			1.9918, -1.2218, 0.3022, -0.5695, -0.1669, -0.874, -0.3534, -1.3181, 1.0783, 0.179, 0.4364, 1.5229, 1.193,
			-0.1353, -0.3582, 1.2075, -2.0735, 0.7683, -0.8212, -0.684, 0.2813, -0.0873, 0.7191, 0.0634, 0.4517, 3.3791,
			0.9731, 1.6258, -0.2393, -0.3608, 1.1992, 0.6792, 0.4401, 1.5342, 1.1443, 1.4643, -0.1317, -0.8544, -0.0572,
			-0.8327, 0.4243, -0.4807, 0.6469, -0.5475, -0.1221, -1.1126, -0.227, 0.0938, 0.8826, -0.7598, -0.4078, -1.0298,
			-0.0333, 0.8587, 1.0506, -0.9323, 0.6828, -0.4533, 1.032, 1.1064, -0.7568, 0.3011, 0.154, -0.7876, 0.9038, 0.0871,
			-1.566, -0.0519, -1.123, 1.4479, -0.383, 0.813, -0.6654, -1.0941, -0.7547, 1.6112, -1.3142, -0.059, -0.1032,
			-0.6535, -1.6, 0.3899, 0.8657, 0.1659, 0.9718, 1.3485, -2.6371, -0.5924, 0.6875, -1.9777, 0.4719, -1.1743,
			-0.9457, 0.8477, 0.5503, -0.3919, 0.7641, 1.3974, 0.8766, -0.3368, 0.1116, 1.5204, 0.4353, -0.6153, 0.4029,
			0.2723, -0.7294, -0.1314, -0.3509, 1.2011, 0.629, -0.7059, 0.8785, -0.1248, 1.8837, -0.5506, -0.6275, 1.4446,
			-0.478, 1.137, 0.6607, 0.4485, 1.1051, -0.4572, 0.258, -1.3841, 0.5051, -0.6507, -0.2292, -0.9049, -0.6433,
			0.3139, 0.4319, -1.0166, 0.789, -0.3325, -1.8782, -1.4303, -0.3283, 0.7972, 0.0515, -0.2758, 0.3642, -0.0145,
			1.5147, -0.0828, -1.1849, 0.3411, -0.9914, -1.4523, -0.2721, 0.7051, 0.0039, -0.5967, -1.3362, -1.5439, -0.8269,
			-0.9893, -0.0351, -0.1545, 0.2337, 1.5534, -0.1101, 1.1068, -1.097, 0.5332, 0.323, -0.5453, -0.2808, 0.7715,
			-0.2057, 0.9422, 0.152, -0.2089, 1.0938, -0.0624, -0.3385, -0.2336, -0.2999, 0.2423, -1.0636, -0.0463, 0.9296,
			0.5478, -0.3901, 2.1153, -0.9051, 0.481, 1.1031, -0.4627, -1.6395, 0.114, -0.5197, -0.9867, 0.7405, 0.3717,
			1.7865, 0.3874, -0.626, -0.1876, -0.9098, -0.3728, 0.0743, 1.4585, 0.7414, 1.1554, 0.4187, 0.7909, -0.125,
			-0.3249, -2.1215, -3.2064, -0.6107, -1.0973, -0.3684, 0.2981, 2.1454, 2.4032, 0.5398, -1.2252, 2.1322, 0.8356,
			-0.3881, -0.9092, 1.6468, 1.0269, -1.4163, -0.3381, -1.2489, -0.0926, 0.6219, 1.4155, -0.093, -0.1936, -0.926,
			-0.8913, 2.2866, 0.0661, -0.4992, -0.0817, -0.0619, -0.8413, 1.7945, 2.2704, -0.6341, -1.3158, 0.9256, 2.6339,
			0.0874, 0.1346, 0.3904, -0.8486, -0.3415, 0.0409, 1.1871, 0.9101, -0.5829, -0.6264, -0.8343, 1.7548, 0.0779,
			1.2172, -1.4385, 0.7853, 0.8539, 0.9487, 0.3068, -0.6907, -0.0654, -0.1342, -1.3062, -0.1238, -0.3526, 0.4646,
			1.1075, 0.7894, -1.5134, -0.3354, -0.7223, -1.0456, -1.7724, 0.0202, 0.6597, 0.0151, -0.3651, 1.1514, -0.5535,
			-1.3579, -0.175, -0.4206, 0.1062, 1.1094, -0.9649, -1.5672, -0.6551, 0.3166, 0.4565, 1.546, 0.3019, -1.1035,
			0.188, 0.1958, 0.6828, 0.1404, -1.1767, -0.0825, 0.1545, -1.0426, 0.5369, -2.3775, 0.8138, -0.2459, 0.4612,
			1.9337, 0.5189, 0.0927, 0.7411, -0.8352, 1.6714, 1.4904, -0.2914, -0.6502, -1.2538, 0.8945, 0.4762, 0.8111, 0.631,
			-0.8571, -1.32, 0.7525, 0.6647, 1.0554, 0.6403, 1.5997, -1.0572, -0.6965, -2.0395, -0.6944, 0.6039, -1.618,
			0.6303, 3.9531, -0.9896, -0.263, 1.4533, -2.1321, 1.3837, -0.2451, -0.4585, -0.1786, 0.0061, -0.1454, -0.194,
			0.6541
		],
		group2_id: 'group2_id_iter1',
		group2_values: [
			0.5822, 0.1826, 0.4364, 0.5622, 0.374, 0.0285, 0.8746, 0.4892, 0.8042, 0.7539, 0.3828, 0.9744, 0.8634, 0.7725,
			0.7008, 0.8992, 0.7847, 0.1179, 0.3997, 0.4536, 0.2509, 0.0244, 0.9686, 0.852, 0.0354, 0.3439, 0.2271, 0.1814,
			0.5497, 0.8893, 0.0051, 0.3557, 0.0484, 0.724, 0.7597, 0.5889, 0.73, 0.4089, 0.6884, 0.1619, 0.8639, 0.5149,
			0.2375, 0.009, 0.0465, 0.7083, 0.7363, 0.0446, 0.1848, 0.1486, 0.7031, 0.366, 0.5218, 0.3225, 0.1136, 0.0042,
			0.3555, 0.7773, 0.5677, 0.5298, 0.2327, 0.0913, 0.8241, 0.6438, 0.537, 0.4216, 0.5281, 0.9575, 0.4026, 0.7231,
			0.8894, 0.7438, 0.8917, 0.4341, 0.2718, 0.4249, 0.0846, 0.9024, 0.0746, 0.9827, 0.7809, 0.5632, 0.7614, 0.2986,
			0.99, 0.5423, 0.2913, 0.6365, 0.0063, 0.4383, 0.6697, 0.822, 0.9177, 0.3952, 0.4829, 0.5773, 0.3927, 0.6085,
			0.1769, 0.5478, 0.1154, 0.3441, 0.2884, 0.5719, 0.6097, 0.64, 0.7839, 0.9612, 0.1172, 0.1576, 0.9242, 0.691, 0.62,
			0.3982, 0.211, 0.7711, 0.8654, 0.5969, 0.486, 0.8093, 0.3707, 0.1228, 0.3938, 0.9962, 0.4983, 0.9819, 0.7655,
			0.8594, 0.1341, 0.4535, 0.6056, 0.8351, 0.4039, 0.0155, 0.8666, 0.8627, 0.041, 0.0197, 0.8993, 0.0293, 0.1168,
			0.0796, 0.0638, 0.4752, 0.8428, 0.6162, 0.2292, 0.2962, 0.0988, 0.0401, 0.7741, 0.5819, 0.1985, 0.0444, 0.0211,
			0.7382, 0.5132, 0.5312, 0.3065, 0.654, 0.0286, 0.1825, 0.52, 0.8484, 0.6834, 0.301, 0.2697, 0.3529, 0.2042,
			0.6651, 0.4111, 0.9234, 0.7117, 0.6477, 0.9423, 0.7807, 0.3337, 0.5727, 0.924, 0.946, 0.2604, 0.4362, 0.7815,
			0.283, 0.5177, 0.4265, 0.9381, 0.4915, 0.7965, 0.985, 0.9929, 0.6828, 0.4207, 0.6554, 0.6754, 0.6027, 0.5185,
			0.7338, 0.2527, 0.703, 0.7224, 0.8569, 0.0645, 0.3704, 0.7433, 0.7763, 0.3974, 0.1236, 0.5064, 0.864, 0.927,
			0.3986, 0.5013, 0.9537, 0.6764, 0.4712, 0.8418, 0.602, 0.4347, 0.9963, 0.7461, 0.7251, 0.3911, 0, 0.1032, 0.0643,
			0.9823, 0.9288, 0.8554, 0.3235, 0.7049, 0.7069, 0.8393, 0.763, 0.1211, 0.9457, 0.3049, 0.6992, 0.1204, 0.1786,
			0.2554, 0.5521, 0.2457, 0.0738, 0.3364, 0.0703, 0.0571, 0.5446, 0.0952, 0.1879, 0.7013, 0.423, 0.3689, 0.2292,
			0.0409, 0.9013, 0.7521, 0.3615, 0.7531, 0.0427, 0.5753, 0.5777, 0.9995, 0.0894, 0.6141, 0.6441, 0.4614, 0.3582,
			0.3146, 0.5341, 0.9002, 0.8833, 0.1415, 0.788, 0.1974, 0.6117, 0.3774, 0.4977, 0.5614, 0.0638, 0.857, 0.8756,
			0.3345, 0.4258, 0.2607, 0.834, 0.1137, 0.7204, 0.1635, 0.0232, 0.9582, 0.9509, 0.7672, 0.2897, 0.2529, 0.6308,
			0.1422, 0.6369, 0.5758, 0.0784, 0.1559, 0.9791, 0.6265, 0.7758, 0.1225, 0.8408, 0.6173, 0.0229, 0.3105, 0.4469,
			0.3367, 0.9741, 0.6843, 0.8944, 0.515, 0.1375, 0.3299, 0.5524, 0.719, 0.3334, 0.7919, 0.6586, 0.784, 0.2926,
			0.0483, 0.1356, 0.0804, 0.475, 0.1981, 0.9782, 0.7195, 0.128, 0.4592, 0.8186, 0.9021, 0.0946, 0.6886, 0.7523,
			0.7951, 0.0233, 0.4793, 0.8855, 0.3494, 0.7908, 0.6583, 0.4974, 0.3935, 0.6922, 0.0841, 0.5745, 0.6259, 0.6783,
			0.851, 0.6233, 0.7618, 0.4761, 0.6743, 0.0395, 0.4504, 0.4941, 0.3482, 0.9543, 0.1709, 0.083, 0.5388, 0.4286,
			0.625, 0.4078, 0.6996, 0.831, 0.1977, 0.1005, 0.0097, 0.21, 0.505, 0.0856, 0.5209, 0.2838, 0.6522, 0.8914, 0.8322,
			0.053, 0.6913, 0.4458, 0.911, 0.4615, 0.2312, 0.4761, 0.5775, 0.3742, 0.35, 0.6983, 0.5653, 0.8144, 0.2154,
			0.4793, 0.1058, 0.7165, 0.7966, 0.001, 0.4138, 0.7137, 0.6314, 0.6141, 0.2597, 0.1929, 0.7939, 0.1977, 0.3884,
			0.7601, 0.204, 0.6043, 0.7428, 0.9223, 0.8094, 0.6276, 0.5537, 0.3046, 0.6481, 0.8795, 0.0052, 0.798, 0.5593,
			0.0054, 0.3952, 0.7554, 0.5202, 0.8655, 0.7052, 0.0521, 0.8837, 0.0581, 0.7571, 0.1645, 0.2726, 0.8423, 0.927,
			0.3863, 0.1853, 0.3426, 0.0256, 0.0071, 0.005, 0.911, 0.3455, 0.5564, 0.0755, 0.3147, 0.9516, 0.36, 0.615, 0.024,
			0.5974, 0.5284, 0.6842, 0.3648, 0.0743, 0.8454, 0.0809, 0.0205, 0.0968, 0.9056, 0.9142, 0.7893, 0.5372, 0.9991,
			0.9968, 0.9665, 0.6679, 0.1417, 0.9898, 0.1698, 0.5333, 0.9719, 0.9533, 0.3843, 0.5082, 0.2339, 0.6927, 0.7106,
			0.4634, 0.5793, 0.4071, 0.3178, 0.737, 0.53, 0.2493, 0.674, 0.5009, 0.1814, 0.9475, 0.6691, 0.8572, 0.0485,
			0.4024, 0.0161, 0.6286, 0.8993, 0.9023, 0.1978
		],
		R_pvalue: 7.6245e-24
	}
]

//Wilcoxon test
tape('testarray', async function (test) {
	for (const data of testData) {
		const pv1 = data.R_pvalue
		delete data.R_pvalue
		const output = await run_rust('wilcoxon', JSON.stringify([data]))
		const pv2 = JSON.parse(output)[0].pvalue
		// hardcode an allowed difference. the pvalues are generally very close
		test.ok(Math.abs(pv2 - pv1) < 0.0001, `R pvalue=${pv1}, Rust pvalue=${pv2}`)
	}
	test.end()
})
